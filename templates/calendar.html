<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Relatórios - 20ª CIPM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .calendar-day {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .calendar-date {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFDC00;
        }
        .report-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .report-submitted {
            background-color: rgba(40, 167, 69, 0.3);
            border-left: 4px solid #28a745;
        }
        .report-missing {
            background-color: rgba(220, 53, 69, 0.3);
            border-left: 4px solid #dc3545;
        }
        .location-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
        }
        .location-muana {
            background-color: #007bff;
        }
        .location-ponta {
            background-color: #6f42c1;
        }
        .shift-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .shift-day {
            background-color: #ffc107;
            color: #212529;
        }
        .shift-night {
            background-color: #343a40;
        }
        .calendar-nav {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #loadingSpinner {
            display: none;
            margin: 50px auto;
        }
        #errorMessage {
            display: none;
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <header class="py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1>Calendário de Relatórios - 20ª CIPM</h1>
            <a href="/" class="btn btn-outline-light"><i class="bi bi-house-fill"></i> Página Inicial</a>
        </div>
    </header>

    <div class="container mt-4">
        <div class="calendar-container">
            <div class="calendar-nav">
                <div>
                    <h2 class="mb-0">Controle de Relatórios Diários</h2>
                    <p class="text-muted">Verifique quais relatórios já foram cadastrados e quais ainda estão pendentes</p>
                </div>
                <div>
                    <button id="prevBtn" class="btn btn-outline-light me-2">
                        <i class="bi bi-arrow-left"></i> Anteriores
                    </button>
                    <button id="todayBtn" class="btn btn-warning">
                        <i class="bi bi-calendar-check"></i> Hoje
                    </button>
                    <button id="nextBtn" class="btn btn-outline-light ms-2">
                        Próximos <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div id="loadingSpinner" class="text-center">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Carregando calendário de relatórios...</p>
            </div>

            <div id="errorMessage"></div>

            <div id="calendar">
                <!-- Calendário será preenchido dinamicamente aqui -->
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentStartDate = null;
        const daysToShow = 30;

        // Formatar data para exibição em PT-BR
        function formatDateBR(dateString) {
            const [day, month, year] = dateString.split('/');
            const date = new Date(`${year}-${month}-${day}`);
            
            // Obter nomes de dias e meses em português
            const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            return `${dayNames[date.getDay()]}, ${day} de ${monthNames[date.getMonth()]} de ${year}`;
        }

        // Verificar se uma data é hoje
        function isToday(dateString) {
            const [day, month, year] = dateString.split('/');
            const inputDate = new Date(`${year}-${month}-${day}`);
            const today = new Date();
            
            return inputDate.getDate() === today.getDate() && 
                   inputDate.getMonth() === today.getMonth() && 
                   inputDate.getFullYear() === today.getFullYear();
        }

        // Renderizar o calendário
        function renderCalendar(calendarData) {
            const calendarContainer = document.getElementById('calendar');
            calendarContainer.innerHTML = '';
            
            if (!calendarData || !calendarData.length) {
                calendarContainer.innerHTML = '<div class="alert alert-warning">Nenhum registro de calendário encontrado.</div>';
                return;
            }
            
            calendarData.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                if (isToday(day.date)) {
                    dayElement.style.borderLeft = '5px solid #FFDC00';
                }
                
                // Data
                const dateElement = document.createElement('div');
                dateElement.className = 'calendar-date';
                dateElement.textContent = formatDateBR(day.date);
                dayElement.appendChild(dateElement);
                
                // Relatórios do dia
                day.reports.forEach(report => {
                    const reportElement = document.createElement('div');
                    reportElement.className = `report-item ${report.status === 'submitted' ? 'report-submitted' : 'report-missing'}`;
                    
                    const infoDiv = document.createElement('div');
                    
                    // Local
                    const locationBadge = document.createElement('span');
                    locationBadge.className = `location-badge ${report.location === 'MUANÁ' ? 'location-muana' : 'location-ponta'}`;
                    locationBadge.textContent = report.location;
                    infoDiv.appendChild(locationBadge);
                    
                    // Turno
                    const shiftBadge = document.createElement('span');
                    shiftBadge.className = `shift-badge ${report.shift.includes('Diurno') ? 'shift-day' : 'shift-night'}`;
                    shiftBadge.textContent = report.shift.includes('Diurno') ? 'Diurno' : 'Noturno';
                    infoDiv.appendChild(shiftBadge);
                    
                    reportElement.appendChild(infoDiv);
                    
                    // Status
                    const statusDiv = document.createElement('div');
                    if (report.status === 'submitted') {
                        statusDiv.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i> <span>Enviado</span>';
                    } else {
                        statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i> <span>Pendente</span>';
                    }
                    reportElement.appendChild(statusDiv);
                    
                    dayElement.appendChild(reportElement);
                });
                
                calendarContainer.appendChild(dayElement);
            });
        }

        // Carregar o calendário
        function loadCalendar(startDate = null) {
            // Mostrar loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Construir URL
            let url = `/api/calendar?days=${daysToShow}`;
            if (startDate) {
                url += `&start_date=${startDate}`;
            }
            
            // Fazer a requisição
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar o calendário');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        renderCalendar(data.calendar);
                        // Atualizar data atual (primeira data do calendário)
                        if (data.calendar && data.calendar.length > 0) {
                            currentStartDate = data.calendar[0].date;
                        }
                    } else {
                        throw new Error(data.error || 'Erro desconhecido');
                    }
                })
                .catch(error => {
                    document.getElementById('errorMessage').textContent = `Erro: ${error.message}`;
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('calendar').innerHTML = '';
                })
                .finally(() => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }

        // Calcular nova data a partir de uma data de referência
        function calculateNewDate(referenceDate, daysToAdd) {
            if (!referenceDate) return null;
            
            const [day, month, year] = referenceDate.split('/');
            const date = new Date(`${year}-${month}-${day}`);
            date.setDate(date.getDate() + daysToAdd);
            
            // Formatar de volta para DD/MM/YYYY
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        // Event Listeners para os botões de navegação
        document.getElementById('prevBtn').addEventListener('click', () => {
            loadCalendar(calculateNewDate(currentStartDate, -daysToShow));
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            loadCalendar(calculateNewDate(currentStartDate, daysToShow));
        });
        
        document.getElementById('todayBtn').addEventListener('click', () => {
            loadCalendar(); // Sem data inicial, vai usar a data atual
        });

        // Carregar o calendário inicial
        document.addEventListener('DOMContentLoaded', () => {
            loadCalendar();
        });
    </script>
</body>
</html>