<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Relatórios - 20ª CIPM</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Base Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Calendar Specific Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
</head>
<body>
    <!-- Header Section -->
    <header class="header-container">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="logo-text animate__animated animate__fadeInLeft">
                        <i class="fas fa-calendar-check logo-icon"></i>
                        20ª CIPM - Controle de Relatórios
                    </h1>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <a href="/" class="btn btn-primary-custom animate__animated animate__fadeInRight">
                        <i class="fas fa-home me-2"></i>Página Inicial
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="calendar-container animate__animated animate__fadeIn">
            <!-- Title Section -->
            <div class="mb-4">
                <h2 class="calendar-title">Calendário de Produtividade</h2>
                <p class="calendar-subtitle">Monitore os relatórios enviados e pendentes para cada dia, local e turno</p>
            </div>

            <!-- Status Summary -->
            <div class="status-summary mb-4">
                <div class="row">
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="status-card">
                            <i class="fas fa-calendar-check status-icon text-primary"></i>
                            <div class="status-info">
                                <h3 class="status-value" id="totalDays">--</h3>
                                <p class="status-label">Dias no Período</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="status-card">
                            <i class="fas fa-file-alt status-icon text-success"></i>
                            <div class="status-info">
                                <h3 class="status-value" id="submittedReports">--</h3>
                                <p class="status-label">Relatórios Enviados</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="status-card">
                            <i class="fas fa-exclamation-triangle status-icon text-danger"></i>
                            <div class="status-info">
                                <h3 class="status-value" id="missingReports">--</h3>
                                <p class="status-label">Relatórios Pendentes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="status-card">
                            <i class="fas fa-chart-pie status-icon text-warning"></i>
                            <div class="status-info">
                                <h3 class="status-value" id="completionRate">--</h3>
                                <p class="status-label">Taxa de Conclusão</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Bar -->
            <div class="calendar-nav mb-4">
                <div>
                    <h3 class="mb-0 fs-5" id="currentPeriodText">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Relatórios: <span id="dateRangeDisplay">Carregando...</span>
                    </h3>
                </div>
                <div class="nav-buttons">
                    <button id="prevBtn" class="nav-btn nav-btn-prev">
                        <i class="fas fa-chevron-left nav-icon"></i>
                        <span>Anteriores</span>
                    </button>
                    <button id="todayBtn" class="nav-btn nav-btn-today mx-2">
                        <i class="fas fa-calendar-day nav-icon"></i>
                        <span>Hoje</span>
                    </button>
                    <button id="nextBtn" class="nav-btn nav-btn-next">
                        <span>Próximos</span>
                        <i class="fas fa-chevron-right nav-icon"></i>
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-container" style="display: none;">
                <div class="spinner"></div>
                <p class="loading-text">Carregando calendário de relatórios...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-container" style="display: none;">
                <i class="fas fa-exclamation-circle error-icon"></i>
                <p class="error-message">Erro ao carregar o calendário.</p>
            </div>

            <!-- Calendar View -->
            <div id="calendar">
                <!-- Calendário será preenchido dinamicamente aqui -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Polícia Militar do Pará - 20ª CIPM</p>
            <div class="footer-divider"></div>
            <p>Sistema de Análise de Produtividade © 2025</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Calendar Script -->
    <script>
        // Variáveis globais
        let currentStartDate = null;
        const daysToShow = 30;
        
        // Contador de relatórios
        let totalSubmitted = 0;
        let totalMissing = 0;
        
        // Formatar data para exibição em PT-BR
        function formatDateBR(dateString) {
            const [day, month, year] = dateString.split('/');
            const date = new Date(`${year}-${month}-${day}`);
            
            // Obter nomes de dias e meses em português
            const dayNames = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                               'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            return { 
                weekday: dayNames[date.getDay()],
                day: day,
                month: monthNames[date.getMonth()],
                year: year,
                fullDate: `${day} de ${monthNames[date.getMonth()]} de ${year}`,
                shortMonth: monthNames[date.getMonth()].substring(0, 3)
            };
        }

        // Verificar se uma data é hoje
        function isToday(dateString) {
            const [day, month, year] = dateString.split('/');
            const inputDate = new Date(`${year}-${month}-${day}`);
            const today = new Date();
            
            return inputDate.getDate() === today.getDate() && 
                   inputDate.getMonth() === today.getMonth() && 
                   inputDate.getFullYear() === today.getFullYear();
        }
        
        // Formatar período de datas
        function formatDateRange(startDate, endDate) {
            if (!startDate || !endDate) return "Período atual";
            
            const start = formatDateBR(startDate);
            const end = formatDateBR(endDate);
            
            if (start.month === end.month && start.year === end.year) {
                return `${start.day} a ${end.day} de ${start.month} de ${start.year}`;
            } else if (start.year === end.year) {
                return `${start.day} ${start.shortMonth} - ${end.day} ${end.shortMonth} ${end.year}`;
            } else {
                return `${start.day}/${start.shortMonth}/${start.year} - ${end.day}/${end.shortMonth}/${end.year}`;
            }
        }
        
        // Atualizar contadores de status
        function updateStatusCounters(calendarData) {
            if (!calendarData || !calendarData.length) return;
            
            totalSubmitted = 0;
            totalMissing = 0;
            
            // Contar relatórios enviados e pendentes
            calendarData.forEach(day => {
                day.reports.forEach(report => {
                    if (report.status === 'submitted') {
                        totalSubmitted++;
                    } else {
                        totalMissing++;
                    }
                });
            });
            
            // Atualizar os contadores na UI
            document.getElementById('totalDays').textContent = calendarData.length;
            document.getElementById('submittedReports').textContent = totalSubmitted;
            document.getElementById('missingReports').textContent = totalMissing;
            
            // Calcular a taxa de conclusão
            const totalReports = totalSubmitted + totalMissing;
            const completionRate = totalReports > 0 ? Math.round((totalSubmitted / totalReports) * 100) : 0;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
            
            // Atualizar o intervalo de datas
            if (calendarData.length > 0) {
                const firstDate = calendarData[0].date;
                const lastDate = calendarData[calendarData.length - 1].date;
                document.getElementById('dateRangeDisplay').textContent = formatDateRange(firstDate, lastDate);
            }
        }

        // Renderizar o calendário
        function renderCalendar(calendarData) {
            const calendarContainer = document.getElementById('calendar');
            calendarContainer.innerHTML = '';
            
            if (!calendarData || !calendarData.length) {
                calendarContainer.innerHTML = `
                    <div class="error-container">
                        <i class="fas fa-calendar-times error-icon"></i>
                        <p class="error-message">Nenhum registro de calendário encontrado para o período selecionado.</p>
                    </div>`;
                return;
            }
            
            calendarData.forEach(day => {
                const formattedDate = formatDateBR(day.date);
                const isCurrentDay = isToday(day.date);
                
                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day ${isCurrentDay ? 'today' : ''}`;
                
                // Data
                const dateElement = document.createElement('div');
                dateElement.className = 'calendar-date';
                dateElement.innerHTML = `
                    <i class="fas fa-calendar-day date-icon"></i>
                    <div>
                        <span class="weekday">${formattedDate.weekday}</span>, 
                        ${formattedDate.day} de ${formattedDate.month} de ${formattedDate.year}
                    </div>
                `;
                dayElement.appendChild(dateElement);
                
                // Relatórios do dia
                day.reports.forEach(report => {
                    const reportElement = document.createElement('div');
                    reportElement.className = `report-item ${report.status === 'submitted' ? 'report-submitted' : 'report-missing'}`;
                    
                    // Informações (Local e Turno)
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'report-info';
                    
                    // Local
                    const locationBadge = document.createElement('span');
                    locationBadge.className = `location-badge ${report.location === 'MUANÁ' ? 'location-muana' : 'location-ponta'}`;
                    locationBadge.innerHTML = `
                        <i class="fas fa-map-marker-alt badge-icon"></i>
                        ${report.location}
                    `;
                    infoDiv.appendChild(locationBadge);
                    
                    // Turno
                    const shiftBadge = document.createElement('span');
                    const isDayShift = report.shift.includes('Diurno');
                    shiftBadge.className = `shift-badge ${isDayShift ? 'shift-day' : 'shift-night'}`;
                    shiftBadge.innerHTML = `
                        <i class="fas ${isDayShift ? 'fa-sun' : 'fa-moon'} badge-icon"></i>
                        ${isDayShift ? 'Diurno' : 'Noturno'}
                    `;
                    infoDiv.appendChild(shiftBadge);
                    
                    reportElement.appendChild(infoDiv);
                    
                    // Status
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'report-status';
                    
                    if (report.status === 'submitted') {
                        statusDiv.innerHTML = `
                            <i class="fas fa-check-circle status-icon status-submitted"></i>
                            <span class="status-submitted">Relatório Enviado</span>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle status-icon status-missing"></i>
                            <span class="status-missing">Pendente</span>
                        `;
                    }
                    reportElement.appendChild(statusDiv);
                    
                    dayElement.appendChild(reportElement);
                });
                
                calendarContainer.appendChild(dayElement);
            });
        }

        // Carregar o calendário
        function loadCalendar(startDate = null) {
            // Mostrar loading spinner
            document.getElementById('loadingSpinner').style.display = 'flex';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('calendar').innerHTML = '';
            
            // Construir URL
            let url = `/api/calendar?days=${daysToShow}`;
            if (startDate) {
                url += `&start_date=${startDate}`;
            }
            
            // Fazer a requisição
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao carregar os dados do calendário');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Renderizar o calendário
                        renderCalendar(data.calendar);
                        
                        // Atualizar data atual (primeira data do calendário)
                        if (data.calendar && data.calendar.length > 0) {
                            currentStartDate = data.calendar[0].date;
                        }
                        
                        // Atualizar contadores de status
                        updateStatusCounters(data.calendar);
                        
                        // Adicionar animação aos cartões
                        setTimeout(() => {
                            const dayCards = document.querySelectorAll('.calendar-day');
                            dayCards.forEach((card, index) => {
                                setTimeout(() => {
                                    card.style.opacity = "1";
                                    card.style.transform = "translateY(0)";
                                }, index * 100);
                            });
                        }, 200);
                    } else {
                        throw new Error(data.error || 'Erro desconhecido no servidor');
                    }
                })
                .catch(error => {
                    const errorMessageElem = document.getElementById('errorMessage');
                    errorMessageElem.querySelector('.error-message').textContent = `Erro: ${error.message}`;
                    errorMessageElem.style.display = 'flex';
                })
                .finally(() => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }

        // Calcular nova data a partir de uma data de referência
        function calculateNewDate(referenceDate, daysToAdd) {
            if (!referenceDate) return null;
            
            const [day, month, year] = referenceDate.split('/');
            const date = new Date(`${year}-${month}-${day}`);
            date.setDate(date.getDate() + daysToAdd);
            
            // Formatar de volta para DD/MM/YYYY
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        // Event Listeners para os botões de navegação
        document.getElementById('prevBtn').addEventListener('click', () => {
            loadCalendar(calculateNewDate(currentStartDate, -daysToShow));
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            loadCalendar(calculateNewDate(currentStartDate, daysToShow));
        });
        
        document.getElementById('todayBtn').addEventListener('click', () => {
            loadCalendar(); // Sem data inicial, vai usar a data atual
        });

        // Carregar o calendário inicial
        document.addEventListener('DOMContentLoaded', () => {
            loadCalendar();
        });
    </script>
</body>
</html>